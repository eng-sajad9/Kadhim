<!doctype html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>سجل المصاريف - بسيط وسريع</title>
	<link rel="icon" href="data:,"><meta name="theme-color" content="#ffffff">
		<style>
			:root{
				--bg:#f6f9fc;
				--card:#ffffff;
				--accent-start:#06b6d4; /* teal */
				--accent-end:#3b82f6;   /* blue */
				--accent:#3b82f6;
				--muted:#6b7280;
				--danger:#ef4444;
				--glass: rgba(255,255,255,0.6);
			}
			html,body{height:100%}
			body{font-family:Inter, Tahoma, Arial, Helvetica, sans-serif;background:linear-gradient(180deg,var(--bg),#ffffff);color:#0f172a;margin:0;padding:12px}
			.container{max-width:920px;margin:0 auto}
			header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
			h1{font-size:20px;margin:0}

			/* Card */
			.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:14px}

			/* Form layout */
			form{display:flex;gap:10px;flex-wrap:wrap}
			input,select,button{padding:10px;border:1px solid #e6eef8;border-radius:10px;font-size:14px}
			input:focus,select:focus,button:focus{outline:none;box-shadow:0 0 0 4px rgba(59,130,246,0.08)}
			input[type=number]{width:140px}
			.actions{display:flex;gap:8px;align-items:center}

			/* Summary */
			.summary{display:flex;gap:14px;flex-wrap:wrap}
			.summary .item{flex:1;min-width:160px}

			ul.entries{list-style:none;padding:0;margin:0}
			li.entry{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:10px;border-bottom:1px dashed #f1f5f9}
			.meta{color:var(--muted);font-size:13px}
			.right{display:flex;gap:8px;align-items:center}
			.small{font-size:12px;color:var(--muted)}
			.danger{color:var(--danger)}
			.controls{display:flex;gap:8px;align-items:center;margin-top:10px}
			.chart-wrap{height:260px}
			footer{font-size:12px;color:var(--muted);margin-top:8px}

			/* Buttons */
			button{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white;border:0;cursor:pointer}
			button.primary{padding:10px 14px;border-radius:10px;font-weight:700}
			button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(59,130,246,0.12)}
			button.small{padding:6px 8px;font-size:13px}
			button.danger{background:transparent;color:var(--danger);border:1px solid rgba(239,68,68,0.12)}
			button[disabled]{opacity:0.5;cursor:not-allowed}

			/* Make numeric inputs left-to-right to force English digits on many locales */
			input[type=number], input[type=date], input[type=month], input[inputmode="numeric"], input[inputmode="decimal"]{direction:ltr;text-align:left}

			/* Responsive */
			@media (max-width:720px){
				header{flex-direction:column;align-items:flex-start;gap:8px}
				form{flex-direction:column}
				.controls{flex-direction:column;align-items:flex-start}
				input[type=number]{width:100%}
			}
		</style>
</head>
<body>
	<div class="container">
		<header>
			<h1>مديّة المصاريف الشهرية</h1>
			<div style="display:flex;gap:8px;align-items:center">
				<div class="small">سهل وسريع — بيانات محفوظة في السحابة</div>
				<span id="syncStatus" class="small" style="margin-left:8px;color:var(--muted)">حالة المزامنة: جارٍ الاتصال…</span>
				<span id="lastSync" class="small" style="margin-left:8px;color:var(--muted)">آخر مزامنة: -</span>
			</div>
		</header>

		<section class="card" aria-labelledby="settings">
			<h2 id="settings" style="margin:0 0 8px 0;font-size:15px">إعدادات الشهر</h2>
			<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
				<label class="small">دخل الشهر (المبلغ المتوفر):</label>
				<input id="monthlyIncome" type="text" inputmode="numeric" pattern="[0-9,]*" placeholder="مثال: 100,000" />
				<button id="saveIncome">حفظ الدخل</button>
				<button id="exportBtn" title="تصدير نسخة احتياطية" style="background:transparent;color:var(--accent);border:1px solid rgba(59,130,246,0.12);padding:8px;border-radius:8px">تصدير</button>
				<input id="importFile" type="file" accept="application/json" style="display:none" />
				<button id="importBtn" title="استيراد نسخة" style="background:transparent;color:var(--accent);border:1px solid rgba(59,130,246,0.12);padding:8px;border-radius:8px">استيراد</button>

				<label class="small" style="margin-right:12px">اختر شهر العرض:</label>
				<input id="monthPicker" type="month" />
			</div>
		</section>

		<section class="card" aria-labelledby="add">
			<h2 id="add" style="margin:0 0 8px 0;font-size:15px">أضف دفعة</h2>
			<form id="entryForm">
				<select id="type">
					<option value="expense">مصروف</option>
					<option value="income">دخل إضافي</option>
				</select>
				<input id="amount" type="text" inputmode="decimal" pattern="[0-9,\.]*" placeholder="المبلغ" required />
				<select id="category"></select>
				<button type="button" id="addCategory" style="background:transparent;color:var(--accent);border:1px solid rgba(59,130,246,0.08);padding:8px;border-radius:8px">إضافة فئة</button>
				<input id="date" type="date" required />
				<input id="desc" type="text" placeholder="وصف (اختياري)" />
				<div class="actions">
					<button type="submit" class="primary">إضافة</button>
					<button type="button" id="clearAll" class="danger">حذف الكل</button>
				</div>
			</form>
		</section>

		<section class="card">
			<div class="summary" id="summary">
				<div class="item card" style="padding:10px">
					<div class="small">إجمالي الدخل المختار</div>
					<div id="showIncome" style="font-weight:700;font-size:18px">0</div>
				</div>
				<div class="item card" style="padding:10px">
					<div class="small">إجمالي المصروفات</div>
					<div id="showExpense" style="font-weight:700;font-size:18px;color:var(--danger)">0</div>
				</div>
				<div class="item card" style="padding:10px">
					<div class="small">الرصيد المتبقي</div>
					<div id="showBalance" style="font-weight:700;font-size:18px">0</div>
				</div>
			</div>

					<div class="controls" style="margin-top:10px">
				<label class="small">فرز حسب:</label>
				<select id="sortBy">
					<option value="date-desc">الأحدث أولاً</option>
					<option value="date-asc">الأقدم أولاً</option>
					<option value="amount-desc">المبلغ (تنازلي)</option>
					<option value="amount-asc">المبلغ (تصاعدي)</option>
				</select>
				<label class="small">بحث:</label>
				<input id="search" type="search" placeholder="وصف أو فئة" />
			</div>
		</section>

		<section class="card">
			<h3 style="margin-top:0">تفاصيل الشهر</h3>
			<div class="chart-wrap">
				<canvas id="chart"></canvas>
			</div>
			<ul id="entriesList" class="entries" style="margin-top:8px"></ul>
		</section>

		<section class="card" aria-labelledby="rangeReport">
			<h3 id="rangeReport" style="margin-top:0">تقرير فترة (عدة أشهر)</h3>
			<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
				<label class="small">من شهر:</label>
				<input id="startMonth" type="month" />
				<label class="small">إلى شهر:</label>
				<input id="endMonth" type="month" />
				<button id="applyRange" class="ghost small">عرض</button>
				<button id="exportRangeCsv" class="ghost small">تصدير CSV للفترة</button>
				<button id="backupNow" class="ghost small">إنشاء نسخة احتياطية سحابية</button>
			</div>
			<div class="chart-wrap" style="margin-top:10px">
				<canvas id="rangeChart"></canvas>
			</div>
			<div id="rangeSummary" style="margin-top:10px" class="small"></div>
		</section>

	</div>

		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script>
		// مفتاح التخزين
		const STORAGE_KEY = 'expenses_app_data_v1';

		// عناصر DOM
		const monthlyIncomeEl = document.getElementById('monthlyIncome');
		const saveIncomeBtn = document.getElementById('saveIncome');
		const monthPicker = document.getElementById('monthPicker');
		const entryForm = document.getElementById('entryForm');
		const amountEl = document.getElementById('amount');
		const categoryEl = document.getElementById('category');
		const dateEl = document.getElementById('date');
		const descEl = document.getElementById('desc');
		const typeEl = document.getElementById('type');
		const entriesList = document.getElementById('entriesList');
		const showIncome = document.getElementById('showIncome');
		const showExpense = document.getElementById('showExpense');
		const showBalance = document.getElementById('showBalance');
		const sortBy = document.getElementById('sortBy');
		const search = document.getElementById('search');
		const clearAllBtn = document.getElementById('clearAll');
		// range report elements
		const startMonthEl = document.getElementById('startMonth');
		const endMonthEl = document.getElementById('endMonth');
		const applyRangeBtn = document.getElementById('applyRange');
		const exportRangeCsvBtn = document.getElementById('exportRangeCsv');
		const backupNowBtn = document.getElementById('backupNow');
		const rangeSummaryEl = document.getElementById('rangeSummary');
		let rangeChart = null;

		// بيانات داخلية
		let state = { settings: { monthlyIncome: 0, categories: ['طعام','سكن/إيجار','فاتورة/مواصلات','مشتريات','ترفيه','أخرى'] }, entries: [] };
		let chart = null;

		// تهيئة تاريخ اليوم
		(function initDate(){
			const today = new Date();
			dateEl.value = today.toISOString().slice(0,10);
			monthPicker.value = today.toISOString().slice(0,7);
		})();

		function loadState(){
			try{
				const raw = localStorage.getItem(STORAGE_KEY);
				if(raw) state = JSON.parse(raw);
			}catch(e){
				console.error('Failed to load state', e);
			}
		}

		// helper for showing sync status from the DB module
		window.updateSyncStatus = function(msg){
			const el = document.getElementById('syncStatus');
			if(!el) return;
			el.textContent = 'حالة المزامنة: ' + msg;
		}

		// update last sync UI helper (module will call this when uploads/downloads happen)
		window.updateLastSync = function(ts){
			const el = document.getElementById('lastSync');
			if(!el) return;
			const d = ts ? new Date(ts) : new Date();
			el.textContent = 'آخر مزامنة: ' + d.toLocaleString();
		}

		function saveState(){
			// set last modified timestamp and persist locally
			state._lastModified = Date.now();
			localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
			// notify Realtime Database sync module (if loaded)
			if(window && typeof window.notifyLocalChange === 'function'){
				window.notifyLocalChange();
			}
		}

			function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

			// عناصر إضافية
			const exportBtn = document.getElementById('exportBtn');
			const importBtn = document.getElementById('importBtn');
			const importFile = document.getElementById('importFile');
			const categorySelect = document.getElementById('category');
			const addCategoryBtn = document.getElementById('addCategory');

			// تنسيق الأرقام أثناء الكتابة (عرض الإنجليزية مع فواصل الآلاف)
			function formatNumberForDisplay(value){
				if(value === null || value === undefined || value === '') return '';
				// accept number or numeric string (may include commas)
				const s = String(value).replace(/,/g,'');
				if(s === '') return '';
				if(s.indexOf('.') >= 0){
					const [intPart, decPart] = s.split('.');
					return new Intl.NumberFormat('en-US').format(Number(intPart)) + '.' + decPart.slice(0,2);
				}
				return new Intl.NumberFormat('en-US').format(Number(s));
			}

			function parseNumberFromInput(str){
				if(!str && str !== 0) return 0;
				const cleaned = String(str).replace(/,/g,'').trim();
				const n = parseFloat(cleaned);
				return Number.isFinite(n) ? n : 0;
			}

			// attach formatting to inputs (monthlyIncome and amount)
			function attachNumberFormatting(inputEl){
				inputEl.addEventListener('input', (e)=>{
					const raw = e.target.value;
					// allow numbers, commas and dot
					const cleaned = raw.replace(/[^0-9\.]/g,'');
					const parts = cleaned.split('.');
					// limit to one dot
					const normalized = parts.length>1 ? parts[0] + '.' + parts.slice(1).join('').slice(0,2) : parts[0];
					e.target.value = formatNumberForDisplay(normalized);
				});
				// format on blur to clean decimals
				inputEl.addEventListener('blur', (e)=>{
					const n = parseNumberFromInput(e.target.value);
					e.target.value = n ? formatNumberForDisplay(n) : '';
				});
			}

			attachNumberFormatting(amountEl);
			attachNumberFormatting(monthlyIncomeEl);

			// Populate categories select
			function refreshCategoryOptions(){
				categorySelect.innerHTML = '';
				for(const c of (state.settings.categories || [])){
					const opt = document.createElement('option'); opt.value = c; opt.textContent = c; categorySelect.appendChild(opt);
				}
			}
			refreshCategoryOptions();

			addCategoryBtn.addEventListener('click', ()=>{
				const v = prompt('أدخل اسم الفئة الجديدة (مثال: تعليم أو صحة):');
				if(!v) return;
				if(!state.settings.categories.includes(v)) state.settings.categories.push(v);
				saveState();
				refreshCategoryOptions();
				categorySelect.value = v;
			});

			// Export / Import JSON
			exportBtn.addEventListener('click', ()=>{
				const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a'); a.href = url; a.download = 'expenses-backup.json'; a.click();
				URL.revokeObjectURL(url);
			});
			importBtn.addEventListener('click', ()=> importFile.click());
			importFile.addEventListener('change', async (e)=>{
				const f = e.target.files && e.target.files[0]; if(!f) return;
				try{
					const txt = await f.text();
					const obj = JSON.parse(txt);
					if(confirm('هل تريد استبدال البيانات الحالية بالبيانات المستوردة؟ اختر OK للاستبدال أو Cancel للدمج')){
						state = obj;
					} else {
						// دمج: نضيف البنود من الملف
						state.settings = Object.assign(state.settings || {}, obj.settings || {});
						state.entries = (state.entries||[]).concat(obj.entries||[]);
					}
					saveState(); refreshCategoryOptions(); render();
					alert('تم استيراد البيانات');
				}catch(err){ alert('فشل استيراد الملف: ' + err.message); }
				importFile.value = '';
			});

			// Firebase placeholders (سنضيف الربط عندما تزودينني بكود التهيئة)
			let firebaseEnabled = false;
			let firebaseApp = null;
			async function initFirebase(config){
				// مثال: ستزودينني بكود التهيئة (config) => سأستدعي initializeApp.
				// لا أدرج مفاتيح هنا. عندما ترسلين الكود سأعدّل الدالة لتربط التطبيق.
				console.log('initFirebase called', config);
				firebaseEnabled = !!config;
			}

			async function syncToFirebase(){
				if(!firebaseEnabled) return console.warn('Firebase غير مُفعّل');
				// هنا سنرسل state إلى قاعدة البيانات بعد تهيئة التوكن والـ SDK
			}

			entryForm.addEventListener('submit', e => {
				e.preventDefault();
				const amt = parseNumberFromInput(amountEl.value);
				if(!amt || amt <= 0) return alert('أدخل مبلغاً صحيحاً');
			const entry = {
				id: uid(),
				type: typeEl.value, // expense or income
					amount: amt,
				category: categoryEl.value,
				date: dateEl.value,
				desc: descEl.value || '',
				createdAt: new Date().toISOString()
			};
			state.entries.push(entry);
			saveState();
			render();
			entryForm.reset();
			dateEl.value = new Date().toISOString().slice(0,10);
		});

			saveIncomeBtn.addEventListener('click', ()=>{
				const v = parseNumberFromInput(monthlyIncomeEl.value) || 0;
				state.settings.monthlyIncome = v;
				saveState();
				render();
				monthlyIncomeEl.value = v ? formatNumberForDisplay(v) : '';
				alert('تم حفظ دخل الشهر');
			});

		clearAllBtn.addEventListener('click', ()=>{
			if(!confirm('هل تريد حذف كل البيانات؟ هذا الإجراء لا يمكن التراجع عنه')) return;
			state = { settings: { monthlyIncome: 0 }, entries: [] };
			saveState();
			render();
		});

		function deleteEntry(id){
			state.entries = state.entries.filter(e=>e.id !== id);
			saveState();
			render();
		}

		function entriesForSelectedMonth(){
			const [y,m] = (monthPicker.value || new Date().toISOString().slice(0,7)).split('-').map(Number);
			return state.entries.filter(e=>{
				const d = new Date(e.date);
				return d.getFullYear()===y && (d.getMonth()+1)===m;
			});
		}

		// Helpers for range/multi-month reporting
		function monthsBetween(startYYYYMM, endYYYYMM){
			const [sy, sm] = startYYYYMM.split('-').map(Number);
			const [ey, em] = endYYYYMM.split('-').map(Number);
			const res = [];
			let y = sy, m = sm;
			while(y < ey || (y===ey && m<=em)){
				res.push(String(y).padStart(4,'0') + '-' + String(m).padStart(2,'0'));
				m++; if(m>12){ m=1; y++; }
			}
			return res;
		}

		function summarizeMonths(months){
			const out = {};
			for(const mon of months){ out[mon] = {income:0, expense:0, byCategory:{}}; }
			for(const e of state.entries){
				const d = new Date(e.date);
				const key = d.toISOString().slice(0,7);
				if(!out[key]) continue;
				if(e.type==='income') out[key].income += e.amount;
				else out[key].expense += e.amount;
				out[key].byCategory[e.category] = (out[key].byCategory[e.category]||0) + (e.type==='expense'?e.amount:0);
			}
			return out;
		}

		function renderRange(){
			const sm = startMonthEl.value || monthPicker.value || new Date().toISOString().slice(0,7);
			const em = endMonthEl.value || sm;
			const months = monthsBetween(sm, em);
			if(months.length===0) return;
			const summary = summarizeMonths(months);
			const labels = months.map(m=>m);
			const expenses = months.map(m=>summary[m].expense||0);
			const incomes = months.map(m=>summary[m].income||0);

			if(rangeChart) rangeChart.destroy();
			const ctx = document.getElementById('rangeChart').getContext('2d');
			rangeChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels,
					datasets: [
						{ label:'مصروف', data: expenses, backgroundColor:'#ef4444' },
						{ label:'دخل', data: incomes, backgroundColor:'#10b981' }
					]
				},
				options: { maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
			});

			let html = '';
			for(const m of months){
				html += `<div style="margin-bottom:6px"><strong>${m}</strong> — إجمالي مصروف: ${formatCurrency(summary[m].expense||0)}، دخل: ${formatCurrency(summary[m].income||0)}</div>`;
			}
			rangeSummaryEl.innerHTML = html;
		}

		function exportRangeCsv(){
			const sm = startMonthEl.value || monthPicker.value || new Date().toISOString().slice(0,7);
			const em = endMonthEl.value || sm;
			const months = monthsBetween(sm, em);
			const rows = [['id','date','type','category','amount','desc','createdAt']];
			for(const e of state.entries){
				const key = e.date.slice(0,7);
				if(months.includes(key)) rows.push([e.id,e.date,e.type,e.category,e.amount,e.desc||'',e.createdAt||'']);
			}
			const csv = rows.map(r=> r.map(c=> '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
			const blob = new Blob([csv], {type:'text/csv'});
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a'); a.href = url; a.download = `expenses_${sm}_to_${em}.csv`; a.click(); URL.revokeObjectURL(url);
		}

		applyRangeBtn.addEventListener('click', ()=> renderRange());
		exportRangeCsvBtn.addEventListener('click', ()=> exportRangeCsv());
		backupNowBtn.addEventListener('click', ()=>{
			if(window.createCloudBackup) window.createCloudBackup().catch(e=>alert('فشل إنشاء النسخة الاحتياطية: '+(e && e.message)));
			else alert('وظيفة النسخ السحابي غير مفعلة');
		});

			// Force English (Latin) digits in displayed numbers
			function formatCurrency(n){
				// show as integer if whole, otherwise 2 decimals
				const value = Number.isInteger(n) ? n : Math.round(n*100)/100;
				return new Intl.NumberFormat('en-US').format(value) + ' د.ع';
			}

		function render(){
			// تعيين قيمة الدخل المحفوظ (منسق)
			monthlyIncomeEl.value = state.settings.monthlyIncome ? formatNumberForDisplay(state.settings.monthlyIncome) : '';

			// الحصول على البنود للشهر
			let items = entriesForSelectedMonth();

			// فلترة البحث
			const q = (search.value || '').trim().toLowerCase();
			if(q){ items = items.filter(it=> (it.desc+ ' ' + it.category).toLowerCase().includes(q)); }

			// فرز
			const s = sortBy.value;
			items.sort((a,b)=>{
				if(s==='date-desc') return new Date(b.date)-new Date(a.date);
				if(s==='date-asc') return new Date(a.date)-new Date(b.date);
				if(s==='amount-desc') return b.amount - a.amount;
				if(s==='amount-asc') return a.amount - b.amount;
				return 0;
			});

			// حساب الملخّص
			let totalIncome = state.settings.monthlyIncome || 0;
			// إضافة أي بنود من نوع income
			totalIncome += items.filter(i=>i.type==='income').reduce((s,i)=>s+i.amount,0);
			const totalExpense = items.filter(i=>i.type==='expense').reduce((s,i)=>s+i.amount,0);
			const balance = totalIncome - totalExpense;

			showIncome.textContent = formatCurrency(totalIncome);
			showExpense.textContent = formatCurrency(totalExpense);
			showBalance.textContent = formatCurrency(balance);

			// عرض القائمة
			entriesList.innerHTML = '';
			for(const it of items){
				const li = document.createElement('li'); li.className='entry';
				const left = document.createElement('div');
				left.innerHTML = `<div style="font-weight:700">${it.category} — ${it.desc || ''}</div><div class="meta">${it.date}</div>`;
				const right = document.createElement('div'); right.className='right';
				const amt = document.createElement('div'); amt.style.fontWeight='700'; amt.textContent = (it.type==='expense'?'- ':'+ ') + formatCurrency(it.amount);
				if(it.type==='expense') amt.className='danger';
				const del = document.createElement('button'); del.textContent='حذف'; del.addEventListener('click', ()=> deleteEntry(it.id));
				right.appendChild(amt); right.appendChild(del);
				li.appendChild(left); li.appendChild(right);
				entriesList.appendChild(li);
			}

			// تحديث الرسم البياني: توزيع المصاريف حسب الفئة
			const expenseItems = items.filter(i=>i.type==='expense');
			const byCat = {};
			for(const e of expenseItems){ byCat[e.category] = (byCat[e.category]||0) + e.amount; }
			const labels = Object.keys(byCat);
			const data = labels.map(l=>byCat[l]);

			if(chart) chart.destroy();
					const ctx = document.getElementById('chart').getContext('2d');
					chart = new Chart(ctx, {
						type: 'doughnut',
						data: {
							labels,
							datasets: [{
								data,
								backgroundColor: ['#06B6D4','#3B82F6','#10B981','#F59E0B','#A78BFA','#F97316']
							}]
						},
						options: {
							maintainAspectRatio: false,
							plugins: { legend: { position: 'bottom', labels: {usePointStyle:true,padding:12} } }
						}
					});
		}

		// أحداث تفاعلية صغيرة
		monthPicker.addEventListener('change', render);
		sortBy.addEventListener('change', render);
		search.addEventListener('input', render);

		// تحميل المبدئي
		loadState();
		// ensure categories exist after loading
		state.settings = state.settings || {};
		state.settings.categories = state.settings.categories || ['طعام','سكن/إيجار','فاتورة/مواصلات','مشتريات','ترفيه','أخرى'];
		refreshCategoryOptions();
		render();

		// تصدير/استيراد (مزايا مستقبلية) — يمكن إضافتها لاحقاً
	</script>

	<!-- Firebase Realtime Database sync (module) -->
	<script type="module">
	  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
	  import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
	  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";

	  const firebaseConfig = {
	    apiKey: "AIzaSyDQxzIZjBuk5ngd2c7ZHhmfvzUq9TU26Yw",
	    authDomain: "mony-ecb81.firebaseapp.com",
	    projectId: "mony-ecb81",
	    storageBucket: "mony-ecb81.firebasestorage.app",
	    messagingSenderId: "1099032510981",
	    appId: "1:1099032510981:web:36e36003b13ffe6d72926c",
	    measurementId: "G-PVHFMZ82XL"
	  };

	  const app = initializeApp(firebaseConfig);
	  try{ getAnalytics(app); }catch(e){}
	  const db = getDatabase(app);
	  const sharedRef = ref(db, 'shared/state');

	  // push local state to Realtime Database
	  window.notifyLocalChange = async function(){
	    try{
	      const raw = localStorage.getItem(STORAGE_KEY);
	      const obj = raw ? JSON.parse(raw) : { settings:{}, entries:[] };
	      obj._lastModified = Date.now();
	      if(window.updateSyncStatus) window.updateSyncStatus('جارٍ رفع…');
	      await set(sharedRef, obj);
	      if(window.updateSyncStatus) window.updateSyncStatus('تم الرفع: ' + new Date().toLocaleTimeString());
	      if(window.updateLastSync) window.updateLastSync(Date.now());
	    }catch(err){ console.error('notifyLocalChange error', err); if(window.updateSyncStatus) window.updateSyncStatus('فشل الرفع'); }
	  }

	  // initial sync and live listener
	  async function startSharedSync(){
	    try{
	      const snap = await get(sharedRef);
	      const rawLocal = localStorage.getItem(STORAGE_KEY);
	      const local = rawLocal ? JSON.parse(rawLocal) : { settings:{}, entries:[] };
	      if(!snap.exists()){
	        local._lastModified = Date.now();
	        await set(sharedRef, local);
		    if(window.updateSyncStatus) window.updateSyncStatus('تم إنشاء السجل في السحابة');
		    if(window.updateLastSync) window.updateLastSync(Date.now());
	      } else {
	        const remote = snap.val();
	        if(remote._lastModified && (!local._lastModified || remote._lastModified > local._lastModified)){
	          localStorage.setItem(STORAGE_KEY, JSON.stringify(remote));
	          if(window.refreshCategoryOptions) window.refreshCategoryOptions();
	          if(window.render) window.render();
		      if(window.updateSyncStatus) window.updateSyncStatus('تم مزامنة التغييرات من السحابة');
		      if(window.updateLastSync) window.updateLastSync(Date.now());
	        } else {
	          local._lastModified = Date.now();
	          await set(sharedRef, local);
		      if(window.updateSyncStatus) window.updateSyncStatus('تم رفع التغييرات');
		      if(window.updateLastSync) window.updateLastSync(Date.now());
	        }
	      }
	    }catch(err){ console.error('initial shared sync error', err); if(window.updateSyncStatus) window.updateSyncStatus('خطأ في المزامنة'); }

	    onValue(sharedRef, (snapshot) => {
	      if(!snapshot.exists()) return;
	      try{
	        const remote = snapshot.val();
	        const rawLocal = localStorage.getItem(STORAGE_KEY);
	        const local = rawLocal ? JSON.parse(rawLocal) : { settings:{}, entries:[] };
				if(remote._lastModified && (!local._lastModified || remote._lastModified > local._lastModified)){
	          localStorage.setItem(STORAGE_KEY, JSON.stringify(remote));
	          if(window.refreshCategoryOptions) window.refreshCategoryOptions();
	          if(window.render) window.render();
				  if(window.updateSyncStatus) window.updateSyncStatus('تحديث تلقائي من السحابة');
				  if(window.updateLastSync) window.updateLastSync(Date.now());
	        } else if(local._lastModified && (!remote._lastModified || local._lastModified > remote._lastModified)){
	          // local newer -> push
	          set(sharedRef, local).catch(e=>console.error('push after onValue error', e));
	          if(window.updateSyncStatus) window.updateSyncStatus('التغييرات المحلية ستُرفع');
	        }
	      }catch(e){ console.error('onValue handler error', e); }
	    }, (err)=>{ console.error('onValue error', err); if(window.updateSyncStatus) window.updateSyncStatus('فشل المزامنة'); });

	  }

	  // start
	  startSharedSync();
	</script>
</body>
</html>

